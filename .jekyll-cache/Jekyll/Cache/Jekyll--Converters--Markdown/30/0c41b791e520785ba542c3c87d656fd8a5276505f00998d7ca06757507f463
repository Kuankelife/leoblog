I"_¢<h4 id="barraæ¨¡å‹åˆæ¢aè‚¡å¸‚åœºé£æ ¼è§£æ">Barraæ¨¡å‹åˆæ¢ï¼ŒAè‚¡å¸‚åœºé£æ ¼è§£æ</h4>

<p><strong>ç ”ç©¶ç›®çš„</strong></p>

<p>æœ¬ç¯‡å†…å®¹æ˜¯å‚è€ƒæ–¹æ­£é‡‘å·¥ç ”ç©¶æŠ¥å‘Šâ€œæ˜Ÿç«â€ å¤šå› å­ç³»åˆ—æŠ¥å‘Šçš„ç¬¬ä¸€ç¯‡ã€ŠBarraæ¨¡å‹åˆæ¢ï¼ŒAè‚¡å¸‚åœºé£æ ¼è§£æã€‹ï¼Œä¸»è¦å¯¹Barraæ¨¡å‹çš„åŸºæœ¬åŸç†è¿›è¡Œä»‹ç»ï¼Œå¯¹æ¨¡å‹çš„ç»†èŠ‚éƒ¨åˆ†è¿›è¡Œè¯´æ˜ï¼Œè¯•å›¾æ„å»ºå¤šå› å­æ”¶ç›Šå½’å› æ¨¡å‹ï¼Œå¹¶åˆ©ç”¨é£é™©æ”¶ç›Šæ¨¡å‹å¯¹Aè‚¡å¸‚åœºçš„é£æ ¼è¿›è¡Œè§£æï¼Œæ¢è®¨ Barra æ¨¡å‹åœ¨ A è‚¡å¸‚åœºä¸Šçš„ç”¨æ­¦ä¹‹åœ°ã€‚</p>

<p><strong>å†…å®¹åˆ†å¸ƒ</strong></p>

<ul>
  <li>1.æ¨¡å‹ä»‹ç»
    <ul>
      <li>1-1.å¤šå› å­æ¨¡å‹ä»‹ç»</li>
      <li>1-2.å› å­æ ‡å‡†åŒ–</li>
      <li>1-3.åŠ æƒæœ€å°äºŒä¹˜æ³•</li>
      <li>1-4.barraé£é™©æ”¶ç›Šå½’å› æ¨¡å‹ä»‹ç»</li>
    </ul>
  </li>
  <li>2.å¸‚åœºä¸»æµå› å­ä»‹ç»
    <ul>
      <li>2-1.å› å­å€¼è®¡ç®—å­˜å‚¨</li>
      <li>2-2.å› å­å€¼å¤„ç†ï¼ˆåŠ å…¥æ”¶ç›Šï¼‰</li>
    </ul>
  </li>
  <li>3.å› å­æ”¶ç›Šç‡è®¡ç®—
    <ul>
      <li>3-1.è¿›è¡Œå› å­æ”¶ç›Šè®¡ç®—</li>
      <li>3-2.å› å­æ”¶ç›Šç»Ÿè®¡åˆ†æ</li>
    </ul>
  </li>
  <li>4.ç»„åˆæ”¶ç›Šå½’å› 
    <ul>
      <li>4-1.æ„å»ºç»„åˆç»Ÿè®¡æ”¶ç›Š</li>
      <li>4-2.ç»„åˆæ”¶ç›Šåˆ†è§£</li>
    </ul>
  </li>
</ul>

<p>##############################################################</p>

<p><strong>å¤šå› å­æ¨¡å‹ä»‹ç»</strong></p>

<p>å¤šå› å­æ¨¡å‹çš„åŸºç¡€ç†è®ºè®¤ä¸ºï¼šè‚¡ç¥¨çš„æ”¶ç›Šæ˜¯ç”±ä¸€äº›å…±åŒçš„å› å­æ¥é©±åŠ¨çš„ï¼Œä¸èƒ½è¢«è¿™äº›å› å­è§£é‡Šçš„éƒ¨åˆ†è¢«ç§°ä¸ºè‚¡ç¥¨çš„â€œç‰¹è´¨æ”¶ç›Šç‡â€ï¼Œ è€Œæ¯æ”¯è‚¡ç¥¨çš„ç‰¹è´¨æ”¶ç›Šç‡ä¹‹é—´æ˜¯äº’ä¸ç›¸å…³çš„ã€‚é‚£å…³äºè¿™äº›å…±åŒçš„å› å­ï¼Œå’Œè‚¡ç¥¨æ”¶ç›Šçš„å…³ç³»ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢çš„å†…å®¹</p>

<p><img src="http://kan.027cgb.com/627139/bgpc/20200618/1.png" /></p>

<p><strong>ç»“æ„åŒ–å› å­é£é™©æ¨¡å‹çš„ä½œç”¨</strong></p>

<p>é£é™©å› å­ä¹Ÿç§°ä¸ºè´å¡”å› å­ï¼Œå’Œ Alpha å› å­ä¸åŒï¼Œ é£é™©å› å­çš„é£é™©æº¢ä»·åœ¨æ—¶é—´åºåˆ—ä¸Šçš„å‡å€¼ç»å¯¹å€¼å¯ä»¥å¾ˆå°ï¼Œç”¨è¿™ä¸ªå› å­æ¥åšé€‰è‚¡é•¿æœŸå¯èƒ½æ²¡æœ‰æ˜æ˜¾è¶…é¢æ”¶ç›Šï¼Œä½†åœ¨æœˆåº¦æ¨ªæˆªé¢ä¸Šé£é™©å› å­å¯ä»¥å½±å“æ˜¾è‘—å½±å“è‚¡ç¥¨æ”¶ç›Šï¼Œæ–¹å‘å¯æ­£å¯è´Ÿã€‚</p>

<p>å› å­æ”¶ç›Šç‡æ³¢åŠ¨å¤§ï¼Œæ§åˆ¶ç»„åˆå¯¹é£é™©å› å­çš„é£é™©æš´éœ²ï¼Œå¯ä»¥æå‡ç»„åˆæ”¶ç›Šçš„ç¨³å®šæ€§ã€‚åŒæ—¶ï¼Œé€šè¿‡å› å­æš´éœ²å’Œå› å­æ”¶ç›Šç‡çš„è®¡ç®—ï¼Œåˆ†ææŠ•èµ„ç»„åˆå†å²å’Œå½“å‰çš„é£é™©é£é™©æš´éœ²ï¼Œå¯ä»¥è¿›è¡Œæ”¶ç›Šåˆ†æã€‚</p>

<p>åœ¨ç»„åˆä¼˜åŒ–æ–¹é¢ï¼Œä¼ ç»Ÿæ ·æœ¬åæ–¹å·®çŸ©é˜µä¼°è®¡æ–¹æ³•åœ¨è‚¡ç¥¨æ•°é‡è¾ƒå¤šæ—¶ï¼ŒçŸ©é˜µå¯èƒ½ä¸æ»¡ç§©æˆ–è€…çŸ©é˜µæ¡ä»¶æ•°
å¤ªå¤§ï¼Œæ— æ³•ç›´æ¥ç”¨äºç»„åˆä¼˜åŒ–è¿‡ç¨‹ã€‚ç»“æ„åŒ–å› å­é£é™©æ¨¡å‹é€šè¿‡é™ç»´çš„æ–¹å¼å‡å°äº†è‚¡ç¥¨æ”¶ç›Šç‡åæ–¹å·®çŸ©é˜µçš„ä¼°è®¡è¯¯å·®ï¼Œä¾¿äºé£é™©é¢„æµ‹ã€‚
ä¸‹é¢çœ‹ä¸‹å¤„ç†çš„ä¸€äº›ç»†èŠ‚</p>

<p><strong>å› å­æ ‡å‡†åŒ–</strong></p>

<p>ç”±äºä¸åŒå› å­åœ¨æ•°é‡çº§ä¸Šå­˜åœ¨å·®åˆ«ï¼Œ åœ¨å®é™…å›å½’ä¸­éœ€è¦å¯¹å•ä¸ªå› å­åœ¨æ¨ªæˆªé¢ä¸Šè¿›è¡Œæ ‡å‡†åŒ–ï¼Œ ä»è€Œå¾—åˆ°å‡å€¼ä¸º 0ã€æ ‡å‡†å·®ä¸º 1 çš„æ ‡å‡†åŒ–å› å­ï¼Œè¿™é‡Œéœ€è¦ç‰¹åˆ«æ³¨æ„ä¸€ä¸‹çš„æ˜¯ï¼Œä¸ºä¿è¯å…¨å¸‚åœºåŸºå‡†æŒ‡æ•°å¯¹æ¯ä¸ªé£æ ¼å› å­çš„æš´éœ²ç¨‹åº¦å‡ä¸º 0ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ¯ä¸ªå› å­å‡å»å…¶å¸‚å€¼åŠ æƒå‡å€¼ï¼Œå†é™¤ä»¥å…¶æ ‡å‡†å·®ï¼Œè®¡ç®—æ–¹æ³•å¦‚ä¸‹
!\(\begin{array}{l}
X_{i k}=\frac{X_{i k}^{R a w}-\mu_{k}}{\sigma_{k}} \\
\mu_{k}=\sum_{i=1}^{N} w_{i} \cdot X_{i k}^{R a w}
\end{array}\)
è€ƒè™‘ä¸€ä¸ªç”±å¸‚å€¼åŠ æƒæ„æˆçš„æŠ•èµ„ç»„åˆï¼Œ å¯ä»¥é€šè¿‡å¦‚ä¸‹éªŒè¯çœ‹å‡ºï¼Œè¯¥æŠ•èµ„ç»„åˆå¯¹äºä»»æ„å› å­çš„æš´éœ²åº¦å‡ä¸º0ã€‚
\(\begin{aligned}
X_{k}^{P}=\sum_{i=1}^{N} w_{i} X_{i k} &amp;=\sum_{i=1}^{N} w_{i} \frac{X_{i k}^{R a w}-\mu_{k}}{\sigma_{k}}=\frac{1}{\sigma_{k}}\left(\sum_{i=1}^{N} w_{i} X_{i k}^{R a w}-\mu_{k} \sum_{i=1}^{N} w_{i}\right) \\
&amp;=\frac{1}{\sigma_{k}}\left(\sum_{i=1}^{N} w_{i} X_{i k}^{R a w}-\mu_{k}\right)=0
\end{aligned}\)</p>

<p><strong>åŠ æƒæœ€å°äºŒä¹˜æ³•</strong></p>

<p>å‰é¢æåˆ°ï¼Œåœ¨ Barra æ¨¡å‹ä¸­æˆ‘ä»¬å‡è®¾æ¯åªè‚¡ç¥¨çš„ç‰¹è´¨æ”¶ç›Šç‡äº’ä¸ç›¸å…³ï¼Œä½†æ˜¯æ¯åªè‚¡ç¥¨çš„ç‰¹è´¨æ”¶ç›Šç‡åˆ—çš„æ–¹å·®å¹¶ä¸ç›¸åŒï¼Œè¿™å°±å¯¼è‡´äº†å›å½’æ¨¡å‹å‡ºç°å¼‚æ–¹å·®æ€§ã€‚ä¸ºè§£å†³è¿™ä¸€é—®é¢˜ï¼Œå¯ä»¥é‡‡ç”¨åŠ æƒæœ€å°äºŒä¹˜WLS æ–¹æ³•è¿›è¡Œå›å½’ï¼Œå¯¹ä¸åŒçš„è‚¡ç¥¨èµ‹äºˆä¸åŒçš„æƒé‡ã€‚
\(\begin{array}{c}
r=X f+u \\
f=\left(X^{T} W X\right)^{-1} X^{T} W r
\end{array}\)
è‚¡ç¥¨ç‰¹è´¨æ”¶ç›Šç‡æ–¹å·®é€šå¸¸ä¸è‚¡ç¥¨çš„å¸‚å€¼è§„æ¨¡æˆåæ¯”ï¼Œå³å¤§å¸‚å€¼è‚¡ç¥¨çš„ç‰¹è´¨æ”¶ç›Šç‡æ–¹å·®é€šå¸¸è¾ƒå°ï¼Œå› æ­¤åœ¨è¿™é‡Œçš„å›å½’å…¬å¼ä¸­ï¼Œæˆ‘ä»¬å°†ä»¥å¸‚å€¼çš„å¹³æ–¹æ ¹å æ¯”ä½œä¸ºæ¯åªè‚¡ç¥¨çš„å›å½’æƒé‡ï¼Œå°†å…¶å¸¦å…¥å…¬å¼è¿›è¡Œè®¡ç®—ï¼Œç„¶ååœ¨æˆ‘ä»¬å®é™…è®¡ç®—çš„è¿‡ç¨‹ä¸­ï¼Œç”±äºXä¸ºå¥‡å¼‚çŸ©é˜µï¼Œå¹¶ä¸èƒ½é¡ºåˆ©æ±‚å‡ºæ”¶ç›Šç‡fï¼Œäºæ˜¯æˆ‘ä»¬é‡‡ç”¨ä¸‹é¢çš„æ–¹æ³•è¿›è¡Œå¤„ç†</p>

<p><strong>é£é™©æ”¶ç›Šæ¨¡å‹ä»‹ç»</strong></p>

<p>è¿™é‡Œå…ˆæ¥çœ‹ä¸‹åœ¨USE4ç‰ˆæœ¬çš„barraæ¨¡å‹ä¸‹ï¼Œæ”¶ç›Šè¡¨è¾¾å¼
\(R S I_{A B}=\frac{\operatorname{mean}\left(C o r r_{t}^{A B}\right)}{\operatorname{std}\left(C o r r_{t}^{A B}\right)}, t=1,2, \dots T\)
æˆªè·é¡¹å› å­çš„åŠ å…¥å¯¼è‡´è‡ªå˜é‡å› å­ä¹‹é—´å­˜åœ¨å¤š
é‡å…±çº¿æ€§ï¼Œ å› æ­¤å› å­çš„æ‹Ÿåˆæ— æ³•ç›´æ¥é€šè¿‡è§£æè§£æ±‚å¾—ï¼Œæ¨¡å‹çš„æ±‚è§£è½¬å˜æˆä¸€ä¸ªå¸¦çº¦æŸæ¡ä»¶çš„åŠ æƒæœ€å°äºŒä¹˜æ³•æ±‚è§£ï¼š
\(\begin{array}{c}
\min \sum_{n} w_{n} \cdot\left(r_{n}-f_{c}-\sum_{i=1} X_{n i} f_{i}-\sum_{s=1} X_{n s} f_{S}\right)^{2} \\
\text { s.t } \sum_{i} w_{i} f_{i}=0
\end{array}\)
æ³¨æ„ï¼Œ æ­¤å¤„wæ˜¯æŒ‡å•åªè‚¡ç¥¨ n çš„å¸‚å€¼æƒé‡ï¼Œè€Œwè¡¨ç¤ºçš„æ˜¯è¡Œä¸šiå†…æ‰€æœ‰è‚¡ç¥¨çš„å¸‚å€¼å å…¨ä½“æ ·æœ¬è‚¡ç¥¨å¸‚å€¼çš„æ¯”ä¾‹ã€‚</p>

<p><strong>å¸‚åœºé£æ ¼å› å­</strong></p>

<p>åŸºäºç ”æŠ¥ä¸­å¯¹ Barra æ¨¡å‹æ¡†æ¶æ„å»ºåŠæ±‚è§£è¿‡ç¨‹çš„ä»‹ç»ï¼Œ æˆ‘ä»¬å‚è€ƒå¹¶æ„å»ºå¤šå› å­é£é™©æ”¶ç›Šå½’å› æ¨¡å‹ï¼Œ å¹¶å°†å…¶è¿ç”¨åˆ° A è‚¡å¸‚åœºä¸Šï¼Œ ä»æˆªè·é¡¹ã€è¡Œä¸šæ”¶ç›Šã€é£æ ¼æ”¶ç›Šä¸‰æ–¹é¢éªŒè¯æ¨¡å‹æ­£ç¡®æ€§ï¼Œ è§‚å¯Ÿå¸‚åœºé£æ ¼çš„å˜åŒ–åŠæŠ•èµ„ç»„åˆçš„é£é™©æ”¶ç›Šæ¥æºã€‚</p>

<p>è¿™é‡Œæˆ‘ä»¬é€‰å–çš„é£æ ¼å› å­å¯ä»¥é€šè¿‡èšå®½å› å­åº“ï¼Œé£æ ¼å› å­è·å–ï¼Œå…·ä½“å­—æ®µåŠè¯´æ˜å¦‚ä¸‹
<img src="http://kan.027cgb.com/627139/bgpc/20200618/2.png" /></p>

<p>é£æ ¼å› å­è·å–åœ°å€ï¼š
https://www.joinquant.com/help/api/help?name=factor_values#%E9%A3%8E%E6%A0%BC%E5%9B%A0%E5%AD%90</p>

<p>æ­¤å¤„æˆ‘ä»¬é‡‡ç”¨ä»¥ä¸Šå› å­ä½œä¸ºæ¨¡å‹çš„è§£é‡Šå˜é‡ï¼Œè¿›è¡Œä¸‹é¢çš„ç ”ç©¶ã€‚</p>

<p>é€‰ å®š 2016.6.1-2019.6.3 ä¸º æ · æœ¬ è€ƒ å¯Ÿ æœŸ é—´ ï¼Œ ä»¥ ä¸­ è¯ 500æŒ‡æ•°ï¼ˆ000905.XSHGï¼‰ æˆåˆ†è‚¡ä¸ºè€ƒå¯Ÿæ ·æœ¬ï¼Œå¯¹å¸‚åœºé£æ ¼å› å­çš„è¡¨ç°è¿›è¡Œå®è¯ç ”ç©¶ï¼Œåœ¨å®é™…è®¡ç®—ä¸­è¿˜éœ€å¯¹æ•°æ®è¿›è¡Œå¦‚ä¸‹å¤„ç†ï¼š</p>

<ul>
  <li>1ï¼‰ å‰”é™¤ä¸Šå¸‚æ—¶é—´å°äº63å¤©çš„è‚¡ç¥¨ï¼›</li>
  <li>2ï¼‰ å‰”é™¤æ ‡è®°ä¸ºSTã€*STçš„è‚¡ç¥¨ï¼›</li>
  <li>3ï¼‰ å‰”é™¤ä»»æ„å› å­ä¸º NaN çš„è‚¡ç¥¨ï¼›</li>
</ul>

<p>å‚è€ƒç ”æŠ¥ä¸­ä¸ºé¿å…å›å½’æ¨¡å‹ä¸­è‡ªå˜é‡ä¹‹é—´äº§ç”Ÿå¤šé‡å…±çº¿æ€§çš„æƒ…å†µï¼Œè€Œå¼•å…¥ç›¸å…³å¼ºåº¦æŒ‡æ ‡RSIï¼Œå¯¹å„é£æ ¼å› å­ä¹‹é—´çš„ç›¸å…³ç¨‹åº¦è¿›è¡Œæ£€æŸ¥ï¼Œè¯¥æŒ‡æ ‡çš„æ„é€ æ–¹æ³•å¦‚ä¸‹
\(R S I_{A B}=\frac{\operatorname{mean}\left(C o r r_{t}^{A B}\right)}{\operatorname{std}\left(C o r r_{t}^{A B}\right)}, t=1,2, \dots T\)</p>

<p>å…¶ä¸­ï¼Œcorr æ˜¯æŒ‡åœ¨æˆªé¢ t æœŸï¼Œæ‰€æœ‰è‚¡ç¥¨çš„ Aã€ B å› å­ä¹‹é—´çš„ç›¸å…³ç³»æ•°ã€‚ç±»ä¼¼äºç»©æ•ˆè¯„ä»·ä¸­çš„ä¿¡æ¯æ¯”ç‡ IC_IRï¼ŒRSIæŒ‡æ ‡ ç»¼åˆè€ƒè™‘äº†å› å­çš„å¹³å‡ç›¸å…³ç³»æ•°ä»¥åŠç›¸å…³ç³»æ•°çš„ç¨³å®šæ€§å¤§å°ï¼Œä¸‹é¢çš„è®¡ç®—ä¸­æœ‰å±•ç¤º2016å¹´åˆ°2019å¹´æœŸé—´å„é£æ ¼å› å­ä¹‹é—´çš„ç›¸å…³å¼ºåº¦ï¼Œå…¶ä¸­å¸‚å€¼å› å­ä¸æ æ†å› å­ä¹‹é—´ã€æ®‹å·®æ³¢åŠ¨ç‡å› å­ä¸æµåŠ¨æ€§å› å­ä¹‹é—´å­˜åœ¨è¾ƒå¼ºçš„æ­£ç›¸å…³å…³ç³»ï¼›è€Œå¸‚å€¼å› å­ä¸éçº¿æ€§å¸‚å€¼å› å­ä¹‹é—´ã€æ æ†å› å­ä¸éçº¿æ€§å¸‚å€¼ä¹‹é—´å­˜åœ¨è¾ƒå¼ºçš„è´Ÿç›¸å…³å…³ç³»ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
</pre></td><td class="rouge-code"><pre><span class="c1">#å·¥å…·åŒ…ã€å·¥å…·å‡½æ•°
#å·¥å…·å‡½æ•°
</span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">jqdata</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">statsmodels</span> <span class="kn">import</span> <span class="n">regression</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="n">sm</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">jqfactor</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">import</span> <span class="nn">warnings</span>  
<span class="n">warnings</span><span class="p">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s">'ignore'</span><span class="p">)</span> 

<span class="c1">#è®¾ç½®ç”»å›¾æ ·å¼
</span><span class="n">plt</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">use</span><span class="p">(</span><span class="s">'ggplot'</span><span class="p">)</span>

<span class="c1">#è·å–æ—¥æœŸåˆ—è¡¨
</span><span class="k">def</span> <span class="nf">get_tradeday_list</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">,</span><span class="n">frequency</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">get_price</span><span class="p">(</span><span class="s">'000001.XSHG'</span><span class="p">,</span><span class="n">end_date</span><span class="o">=</span><span class="n">end</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">get_price</span><span class="p">(</span><span class="s">'000001.XSHG'</span><span class="p">,</span><span class="n">start_date</span><span class="o">=</span><span class="n">start</span><span class="p">,</span><span class="n">end_date</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">frequency</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">frequency</span> <span class="o">==</span><span class="s">'day'</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">.</span><span class="n">index</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s">'year-month'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">frequency</span> <span class="o">==</span> <span class="s">'month'</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span><span class="p">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s">'year-month'</span><span class="p">).</span><span class="n">index</span>
        <span class="k">elif</span> <span class="n">frequency</span> <span class="o">==</span> <span class="s">'quarter'</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s">'month'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="n">index</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s">'month'</span><span class="p">]</span><span class="o">==</span><span class="s">'01'</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'month'</span><span class="p">]</span><span class="o">==</span><span class="s">'04'</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'month'</span><span class="p">]</span><span class="o">==</span><span class="s">'07'</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'month'</span><span class="p">]</span><span class="o">==</span><span class="s">'10'</span><span class="p">)</span> <span class="p">]</span>
            <span class="k">return</span> <span class="n">df</span><span class="p">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s">'year-month'</span><span class="p">).</span><span class="n">index</span>
        <span class="k">elif</span> <span class="n">frequency</span> <span class="o">==</span><span class="s">'halfyear'</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s">'month'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="n">index</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s">'month'</span><span class="p">]</span><span class="o">==</span><span class="s">'01'</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'month'</span><span class="p">]</span><span class="o">==</span><span class="s">'06'</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">df</span><span class="p">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s">'year-month'</span><span class="p">).</span><span class="n">index</span> 

<span class="k">def</span> <span class="nf">ShiftTradingDay</span><span class="p">(</span><span class="n">date</span><span class="p">,</span><span class="n">shift</span><span class="p">):</span>
    <span class="c1"># è·å–æ‰€æœ‰çš„äº¤æ˜“æ—¥ï¼Œè¿”å›ä¸€ä¸ªåŒ…å«æ‰€æœ‰äº¤æ˜“æ—¥çš„ list,å…ƒç´ å€¼ä¸º datetime.date ç±»å‹.
</span>    <span class="n">tradingday</span> <span class="o">=</span> <span class="n">get_all_trade_days</span><span class="p">()</span>
    <span class="c1"># å¾—åˆ°dateä¹‹åshiftå¤©é‚£ä¸€å¤©åœ¨åˆ—è¡¨ä¸­çš„è¡Œæ ‡å· è¿”å›ä¸€ä¸ªæ•°
</span>    <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">date</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="p">)[:</span><span class="mi">4</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="p">)[</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="p">)[</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p">]))</span>
    <span class="n">shiftday_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tradingday</span><span class="p">).</span><span class="n">index</span><span class="p">(</span><span class="n">date</span><span class="p">)</span><span class="o">+</span><span class="n">shift</span>
    <span class="c1"># æ ¹æ®è¡Œå·è¿”å›è¯¥æ—¥æ—¥æœŸ ä¸ºdatetime.dateç±»å‹
</span>    <span class="k">return</span> <span class="n">tradingday</span><span class="p">[</span><span class="n">shiftday_index</span><span class="p">]</span> 

<span class="c1">#è¿›è¡Œæ–°è‚¡ã€Stè‚¡è¿‡æ»¤ï¼Œè¿”å›ç­›é€‰åçš„è‚¡ç¥¨
#ï¼ï¼ï¼ä¸èƒ½è¿‡æ»¤åœç‰Œè‚¡ç¥¨
</span><span class="k">def</span> <span class="nf">filter_stock</span><span class="p">(</span><span class="n">stockList</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">days</span><span class="o">=</span><span class="mi">21</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span><span class="n">limit</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span><span class="c1">#æ—¥é¢‘ç­–ç•¥åŠ å…¥å¼€ç›˜æ¶¨åœè¿‡æ»¤
</span>    
    <span class="c1">#å»é™¤ä¸Šå¸‚è·beginDateä¸è¶³3ä¸ªæœˆçš„è‚¡ç¥¨
</span>    <span class="k">def</span> <span class="nf">delect_stop</span><span class="p">(</span><span class="n">stocks</span><span class="p">,</span><span class="n">beginDate</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">days</span><span class="p">):</span>
        <span class="n">stockList</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">beginDate</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">beginDate</span><span class="p">,</span> <span class="s">"%Y-%m-%d"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">stock</span> <span class="ow">in</span> <span class="n">stocks</span><span class="p">:</span>
            <span class="n">start_date</span><span class="o">=</span><span class="n">get_security_info</span><span class="p">(</span><span class="n">stock</span><span class="p">).</span><span class="n">start_date</span>
            <span class="k">if</span> <span class="n">start_date</span><span class="o">&lt;</span><span class="p">(</span><span class="n">beginDate</span><span class="o">-</span><span class="n">datetime</span><span class="p">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">n</span><span class="p">)).</span><span class="n">date</span><span class="p">():</span>
                <span class="n">stockList</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">stock</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stockList</span>
    
    <span class="c1">#å‰”é™¤STè‚¡
</span>    <span class="n">st_data</span><span class="o">=</span><span class="n">get_extras</span><span class="p">(</span><span class="s">'is_st'</span><span class="p">,</span><span class="n">stockList</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">end_date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span>
    <span class="n">stockList</span> <span class="o">=</span> <span class="p">[</span><span class="n">stock</span> <span class="k">for</span> <span class="n">stock</span> <span class="ow">in</span> <span class="n">stockList</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">st_data</span><span class="p">[</span><span class="n">stock</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

    <span class="c1">#æ–°è‚¡åŠé€€å¸‚è‚¡ç¥¨
</span>    <span class="n">stockList</span><span class="o">=</span><span class="n">delect_stop</span><span class="p">(</span><span class="n">stockList</span><span class="p">,</span><span class="n">date</span><span class="p">)</span>
    
    <span class="c1">#å‰”é™¤å¼€ç›˜æ¶¨åœè‚¡ç¥¨
</span>    <span class="k">if</span> <span class="n">limit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1">#å¦‚æœéœ€è¦æ”¶ç›˜æ¶¨è·Œåœå¯ä»¥æ”¹å­—æ®µå³å¯
</span>        <span class="n">df</span> <span class="o">=</span> <span class="n">get_price</span><span class="p">(</span><span class="n">stockList</span><span class="p">,</span><span class="n">end_date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s">'open'</span><span class="p">,</span><span class="s">'high_limit'</span><span class="p">,</span><span class="s">'low_limit'</span><span class="p">],</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:]</span>
        <span class="n">df</span><span class="p">[</span><span class="s">'h_limit'</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'open'</span><span class="p">]</span><span class="o">==</span><span class="n">df</span><span class="p">[</span><span class="s">'high_limit'</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s">'l_limit'</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'open'</span><span class="p">]</span><span class="o">==</span><span class="n">df</span><span class="p">[</span><span class="s">'low_limit'</span><span class="p">])</span>
        <span class="n">stockList</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="p">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">h_limit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="n">df</span><span class="p">.</span><span class="n">l_limit</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="c1">#è¿‡æ»¤æ¶¨è·Œåœè‚¡ç¥¨
</span>    <span class="k">return</span> <span class="n">stockList</span>

<span class="c1">#ä¸ºè‚¡ç¥¨æ± æ·»åŠ è¡Œä¸šæ ‡è®°,return dfæ ¼å¼ ,ä¸ºä¸­æ€§åŒ–å‡½æ•°çš„å­å‡½æ•°   
</span><span class="k">def</span> <span class="nf">get_industry_exposure</span><span class="p">(</span><span class="n">stock_list</span><span class="p">,</span><span class="n">date</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">get_industries</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'sw_l1'</span><span class="p">).</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">stock_list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">stock</span> <span class="ow">in</span> <span class="n">stock_list</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">stock</span><span class="p">][</span><span class="n">get_industry_code_from_security</span><span class="p">(</span><span class="n">stock</span><span class="p">,</span><span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="c1">#å°†NaNèµ‹ä¸º0
</span>
<span class="c1">#æŸ¥è¯¢ä¸ªè‚¡æ‰€åœ¨è¡Œä¸šå‡½æ•°ä»£ç ï¼ˆç”³ä¸‡ä¸€çº§ï¼‰ ,ä¸ºä¸­æ€§åŒ–å‡½æ•°çš„å­å‡½æ•°    
</span><span class="k">def</span> <span class="nf">get_industry_code_from_security</span><span class="p">(</span><span class="n">security</span><span class="p">,</span><span class="n">date</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">industry_index</span><span class="o">=</span><span class="n">get_industries</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'sw_l1'</span><span class="p">).</span><span class="n">index</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">industry_index</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">get_industry_stocks</span><span class="p">(</span><span class="n">industry_index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">).</span><span class="n">index</span><span class="p">(</span><span class="n">security</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">industry_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>
    <span class="k">return</span> <span class="s">u'æœªæ‰¾åˆ°'</span>    

</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="c1">#åˆå§‹è®¾ç½®
</span>
<span class="c1">#è®¾ç½®ç»Ÿè®¡æ•°æ®åŒºé—´
</span><span class="n">index</span> <span class="o">=</span> <span class="s">'000905.XSHG'</span> <span class="c1">#è®¾ç½®è‚¡ç¥¨æ± ï¼Œå’Œå¯¹æ¯”åŸºå‡†ï¼Œè¿™é‡Œæ˜¯ä¸­è¯500
</span>
<span class="c1">#è®¾ç½®ç»Ÿè®¡èµ·æ­¢æ—¥æœŸ
</span><span class="n">date_start</span> <span class="o">=</span> <span class="s">'2016-06-01'</span>
<span class="n">date_end</span>   <span class="o">=</span> <span class="s">'2019-06-04'</span>

<span class="c1">#è®¾ç½®è°ƒä»“é¢‘ç‡
</span><span class="n">trade_freq</span> <span class="o">=</span> <span class="s">'month'</span> <span class="c1">#monthæ¯ä¸ªè‡ªç„¶æœˆï¼›dayæ¯ä¸ªäº¤æ˜“æ—¥ï¼›è¾“å…¥ä»»æ„æ•°å­—å¦‚ 5ï¼Œåˆ™ä¸º5æ—¥è°ƒä»“ 
</span>
<span class="c1">#è·å–è°ƒä»“æ—¶é—´åˆ—è¡¨
</span><span class="k">if</span> <span class="n">trade_freq</span> <span class="o">==</span> <span class="s">'month'</span><span class="p">:</span>  
    <span class="c1">#è·å–äº¤æ˜“æ—¥åˆ—è¡¨ï¼Œæ¯æœˆé¦–ä¸ªäº¤æ˜“æ—¥
</span>    <span class="n">date_list</span> <span class="o">=</span> <span class="n">get_tradeday_list</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">date_start</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="n">date_end</span><span class="p">,</span><span class="n">frequency</span><span class="o">=</span><span class="s">'month'</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="c1">#è‡ªç„¶æœˆçš„ç¬¬ä¸€å¤©
</span><span class="k">elif</span> <span class="n">trade_freq</span> <span class="o">==</span> <span class="s">'day'</span><span class="p">:</span> 
    <span class="n">date_list</span> <span class="o">=</span> <span class="n">get_tradeday_list</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">date_start</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="n">date_end</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="c1">#è·å–å›æµ‹æ—¥æœŸé—´çš„æ‰€æœ‰äº¤æ˜“æ—¥
</span><span class="k">else</span><span class="p">:</span>
    <span class="n">date_day_list</span> <span class="o">=</span> <span class="n">get_tradeday_list</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">date_start</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="n">date_end</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="c1">#è·å–å›æµ‹æ—¥æœŸé—´çš„æ‰€æœ‰äº¤æ˜“æ—¥
</span>    <span class="n">date_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">date_day_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">date_day_list</span><span class="p">))</span> <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="nb">int</span><span class="p">(</span><span class="n">trade_freq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">date_list</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>DatetimeIndex(['2016-06-01', '2016-07-01', '2016-08-01', '2016-09-01',
               '2016-10-10', '2016-11-01', '2016-12-01', '2017-01-03',
               '2017-02-03', '2017-03-01', '2017-04-05', '2017-05-02',
               '2017-06-01', '2017-07-03', '2017-08-01', '2017-09-01',
               '2017-10-09', '2017-11-01', '2017-12-01', '2018-01-02',
               '2018-02-01', '2018-03-01', '2018-04-02', '2018-05-02',
               '2018-06-01', '2018-07-02', '2018-08-01', '2018-09-03',
               '2018-10-08', '2018-11-01', '2018-12-03', '2019-01-02',
               '2019-02-01', '2019-03-01', '2019-04-01', '2019-05-06',
               '2019-06-03'],
              dtype='datetime64[ns]', freq=None)
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="c1">#é€šè¿‡èšå®½å› å­è·å–barraé£é™©å› å­å€¼è¿›è¡Œè®°å½•
</span><span class="k">def</span> <span class="nf">get_barra_factor</span><span class="p">(</span><span class="n">stock_list</span><span class="p">,</span><span class="n">date</span><span class="p">):</span>
    <span class="c1">#èšå®½é£é™©å› å­è·å–
</span>    <span class="n">factor_name</span> <span class="o">=</span> <span class="p">[</span><span class="s">'size'</span><span class="p">,</span><span class="s">'beta'</span><span class="p">,</span><span class="s">'momentum'</span><span class="p">,</span><span class="s">'residual_volatility'</span><span class="p">,</span><span class="s">'non_linear_size'</span><span class="p">,</span><span class="s">'book_to_price_ratio'</span><span class="p">,</span><span class="s">'liquidity'</span><span class="p">,</span><span class="s">'earnings_yield'</span><span class="p">,</span><span class="s">'growth'</span><span class="p">,</span><span class="s">'leverage'</span><span class="p">]</span>
    <span class="n">factor_data</span> <span class="o">=</span> <span class="n">get_factor_values</span><span class="p">(</span><span class="n">securities</span><span class="o">=</span><span class="n">stock_list</span><span class="p">,</span> <span class="n">factors</span> <span class="o">=</span> <span class="n">factor_name</span>
            <span class="p">,</span><span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">factor_name</span><span class="p">:</span>
        <span class="n">temp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">factor_data</span><span class="p">[</span><span class="n">f</span><span class="p">]).</span><span class="n">T</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span><span class="n">temp_df</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span><span class="p">.</span><span class="n">columns</span><span class="o">=</span><span class="n">factor_name</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="c1">#è¿›è¡Œå› å­å€¼è®¡ç®—
</span><span class="n">factor_data_dict</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1">#å¾ªç¯æ—¶é—´åˆ—è¡¨è·å–åŸå§‹å› å­æ•°æ®ç»„æˆdict
</span><span class="k">for</span> <span class="n">end_date</span> <span class="ow">in</span> <span class="n">date_list</span><span class="p">[:]:</span>
    <span class="n">end_date</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">end_date</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'æ­£åœ¨è®¡ç®— {} å› å­æ•°æ®......'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">end_date</span><span class="p">))</span>
    <span class="n">stocks_list</span> <span class="o">=</span> <span class="n">get_index_stocks</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">date</span><span class="o">=</span><span class="n">end_date</span><span class="p">)</span>
    <span class="n">factor_data_dict</span><span class="p">[</span><span class="n">end_date</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_barra_factor</span><span class="p">(</span><span class="n">stocks_list</span><span class="p">,</span><span class="n">end_date</span><span class="p">)</span>
<span class="n">factor_data_dict</span><span class="p">[</span><span class="n">end_date</span><span class="p">].</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre>æ­£åœ¨è®¡ç®— 2016-06-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2016-07-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2016-08-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2016-09-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2016-10-10 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2016-11-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2016-12-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-01-03 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-02-03 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-03-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-04-05 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-05-02 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-06-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-07-03 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-08-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-09-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-10-09 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-11-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-12-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-01-02 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-02-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-03-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-04-02 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-05-02 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-06-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-07-02 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-08-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-09-03 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-10-08 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-11-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-12-03 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2019-01-02 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2019-02-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2019-03-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2019-04-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2019-05-06 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2019-06-03 å› å­æ•°æ®......
</pre></td></tr></tbody></table></code></pre></div></div>

<div>

    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>size</th>
      <th>beta</th>
      <th>momentum</th>
      <th>residual_volatility</th>
      <th>non_linear_size</th>
      <th>book_to_price_ratio</th>
      <th>liquidity</th>
      <th>earnings_yield</th>
      <th>growth</th>
      <th>leverage</th>
    </tr>
    <tr>
      <th>code</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>000006.XSHE</th>
      <td>-0.821249</td>
      <td>0.846139</td>
      <td>-0.654765</td>
      <td>-1.122607</td>
      <td>1.350697</td>
      <td>0.721450</td>
      <td>-0.347607</td>
      <td>0.737268</td>
      <td>0.001635</td>
      <td>-0.645989</td>
    </tr>
    <tr>
      <th>000008.XSHE</th>
      <td>-0.672643</td>
      <td>0.236866</td>
      <td>-1.180368</td>
      <td>-0.510980</td>
      <td>1.309040</td>
      <td>0.234178</td>
      <td>-0.036523</td>
      <td>-0.979308</td>
      <td>-0.049531</td>
      <td>-1.181356</td>
    </tr>
    <tr>
      <th>000009.XSHE</th>
      <td>-0.613574</td>
      <td>1.604815</td>
      <td>-0.118106</td>
      <td>-0.391928</td>
      <td>1.261747</td>
      <td>-0.572879</td>
      <td>0.289326</td>
      <td>0.708174</td>
      <td>0.526176</td>
      <td>-0.132690</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="c1">#æ•°æ®æ¸…æ´—ã€åŒ…æ‹¬å»æå€¼ã€æ ‡å‡†åŒ–ã€ä¸­æ€§åŒ–ç­‰,å¹¶åŠ å…¥yå€¼
</span><span class="kn">import</span> <span class="nn">time</span>  
<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">factor_data_y_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">date_1</span><span class="p">,</span><span class="n">date_2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">date_list</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">date_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
    <span class="n">d1</span> <span class="o">=</span> <span class="n">ShiftTradingDay</span><span class="p">(</span><span class="n">date_1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#å¾€åæ¨ä¸€å¤©
</span>    <span class="n">d2</span> <span class="o">=</span> <span class="n">ShiftTradingDay</span><span class="p">(</span><span class="n">date_2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'å¼€å§‹æ•´ç† {} æ•°æ®...'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">date_1</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]))</span>
    <span class="n">factor_df</span> <span class="o">=</span> <span class="n">factor_data_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">date_1</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]]</span> <span class="c1">#æ ¹æ®å­—å…¸å­˜å‚¨çš„æ—¥æœŸæ ¼å¼ä¸åŒè¿›è¡Œä¸åŒè®¾ç½®
</span>    <span class="c1">#factor_df = factor_data_dict[date_1] #æ ¹æ®å­—å…¸å­˜å‚¨çš„æ—¥æœŸæ ¼å¼ä¸åŒè¿›è¡Œä¸åŒè®¾ç½®
</span>    <span class="c1">#factor_df.index = [normalize_code('0'*(6-len(str(i)))+str(i)) for i in factor_df.index] #è‚¡ç¥¨ä»£ç å¤„ç†
</span>    <span class="n">pool</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">factor_df</span><span class="p">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">filter_stock</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">d1</span><span class="p">)[:</span><span class="mi">10</span><span class="p">],</span><span class="n">days</span><span class="o">=</span><span class="mi">21</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#è¿›è¡Œæ–°è‚¡ã€STè‚¡ç¥¨è¿‡æ»¤
</span>    
    <span class="c1">#è®¡ç®—æŒ‡æ•°æ¶¨è·Œå¹…
</span>    <span class="n">df_1</span> <span class="o">=</span> <span class="n">get_price</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">end_date</span><span class="o">=</span><span class="n">d1</span><span class="p">,</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s">'open'</span><span class="p">],</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)[</span><span class="s">'open'</span><span class="p">]</span>
    <span class="n">df_2</span> <span class="o">=</span> <span class="n">get_price</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">end_date</span><span class="o">=</span><span class="n">d2</span><span class="p">,</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s">'open'</span><span class="p">],</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)[</span><span class="s">'open'</span><span class="p">]</span>
    <span class="n">index_pct</span> <span class="o">=</span> <span class="n">df_2</span><span class="p">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">df_1</span><span class="p">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="c1">#å…·ä½“æ•°å€¼
</span>    
    <span class="c1">#è®¡ç®—å„è‚¡ç¥¨æ¶¨è·Œå¹…
</span>    <span class="n">df_1</span> <span class="o">=</span> <span class="n">get_price</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span><span class="n">end_date</span><span class="o">=</span><span class="n">d1</span><span class="p">,</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s">'open'</span><span class="p">],</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)[</span><span class="s">'open'</span><span class="p">]</span>
    <span class="n">df_2</span> <span class="o">=</span> <span class="n">get_price</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span><span class="n">end_date</span><span class="o">=</span><span class="n">d2</span><span class="p">,</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s">'open'</span><span class="p">],</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)[</span><span class="s">'open'</span><span class="p">]</span>
    <span class="n">df_3</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_1</span><span class="p">,</span><span class="n">df_2</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">).</span><span class="n">T</span> <span class="c1">#è¿›è¡Œåˆå¹¶
</span>    <span class="n">stock_pct</span> <span class="o">=</span> <span class="n">df_3</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">df_3</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1">#è®¡ç®—pctï¼Œseries
</span>    
    <span class="c1">#å¯¹æ•°æ®è¿›è¡Œå¤„ç†ã€æ ‡å‡†åŒ–ã€å»æå€¼ã€ä¸­æ€§åŒ–
</span>    <span class="n">factor_df</span> <span class="o">=</span> <span class="n">winsorize_med</span><span class="p">(</span><span class="n">factor_df</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">inclusive</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">inf2nan</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#ä¸­ä½æ•°å»æå€¼å¤„ç†
</span>    <span class="n">factor_df</span> <span class="o">=</span> <span class="n">standardlize</span><span class="p">(</span><span class="n">factor_df</span><span class="p">,</span> <span class="n">inf2nan</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#å¯¹æ¯åˆ—åšæ ‡å‡†åŒ–å¤„ç†
</span>    <span class="c1">#factor_df = neutralize(factor_df, how=how_, date=date_1, axis=0,fillna='sw_l1')#ä¸­æ€§åŒ–
</span>
    <span class="n">factor_df</span><span class="p">[</span><span class="s">'pct_alpha'</span><span class="p">]</span> <span class="o">=</span>  <span class="n">stock_pct</span><span class="o">-</span><span class="n">index_pct</span>
    <span class="n">factor_df</span><span class="p">[</span><span class="s">'pct_'</span><span class="p">]</span> <span class="o">=</span>  <span class="n">stock_pct</span>
    <span class="n">factor_data_y_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">date_1</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]]</span> <span class="o">=</span> <span class="n">factor_df</span>
    
<span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">'è®¡ç®—æ•°æ®è€—æ—¶ï¼š{0}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">factor_data_y_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">date_1</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]].</span><span class="n">shape</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre>å¼€å§‹æ•´ç† 2016-06-01 æ•°æ®...
å¼€å§‹æ•´ç† 2016-07-01 æ•°æ®...
å¼€å§‹æ•´ç† 2016-08-01 æ•°æ®...
å¼€å§‹æ•´ç† 2016-09-01 æ•°æ®...
å¼€å§‹æ•´ç† 2016-10-10 æ•°æ®...
å¼€å§‹æ•´ç† 2016-11-01 æ•°æ®...
å¼€å§‹æ•´ç† 2016-12-01 æ•°æ®...
å¼€å§‹æ•´ç† 2017-01-03 æ•°æ®...
å¼€å§‹æ•´ç† 2017-02-03 æ•°æ®...
å¼€å§‹æ•´ç† 2017-03-01 æ•°æ®...
å¼€å§‹æ•´ç† 2017-04-05 æ•°æ®...
å¼€å§‹æ•´ç† 2017-05-02 æ•°æ®...
å¼€å§‹æ•´ç† 2017-06-01 æ•°æ®...
å¼€å§‹æ•´ç† 2017-07-03 æ•°æ®...
å¼€å§‹æ•´ç† 2017-08-01 æ•°æ®...
å¼€å§‹æ•´ç† 2017-09-01 æ•°æ®...
å¼€å§‹æ•´ç† 2017-10-09 æ•°æ®...
å¼€å§‹æ•´ç† 2017-11-01 æ•°æ®...
å¼€å§‹æ•´ç† 2017-12-01 æ•°æ®...
å¼€å§‹æ•´ç† 2018-01-02 æ•°æ®...
å¼€å§‹æ•´ç† 2018-02-01 æ•°æ®...
å¼€å§‹æ•´ç† 2018-03-01 æ•°æ®...
å¼€å§‹æ•´ç† 2018-04-02 æ•°æ®...
å¼€å§‹æ•´ç† 2018-05-02 æ•°æ®...
å¼€å§‹æ•´ç† 2018-06-01 æ•°æ®...
å¼€å§‹æ•´ç† 2018-07-02 æ•°æ®...
å¼€å§‹æ•´ç† 2018-08-01 æ•°æ®...
å¼€å§‹æ•´ç† 2018-09-03 æ•°æ®...
å¼€å§‹æ•´ç† 2018-10-08 æ•°æ®...
å¼€å§‹æ•´ç† 2018-11-01 æ•°æ®...
å¼€å§‹æ•´ç† 2018-12-03 æ•°æ®...
å¼€å§‹æ•´ç† 2019-01-02 æ•°æ®...
å¼€å§‹æ•´ç† 2019-02-01 æ•°æ®...
å¼€å§‹æ•´ç† 2019-03-01 æ•°æ®...
å¼€å§‹æ•´ç† 2019-04-01 æ•°æ®...
å¼€å§‹æ•´ç† 2019-05-06 æ•°æ®...
è®¡ç®—æ•°æ®è€—æ—¶ï¼š15.776292324066162
(500, 12)
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">df</span> <span class="o">=</span> <span class="n">factor_data_y_dict</span><span class="p">[</span><span class="s">'2019-05-06'</span><span class="p">]</span>
<span class="n">df</span><span class="p">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div>

    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>size</th>
      <th>beta</th>
      <th>momentum</th>
      <th>residual_volatility</th>
      <th>non_linear_size</th>
      <th>book_to_price_ratio</th>
      <th>liquidity</th>
      <th>earnings_yield</th>
      <th>growth</th>
      <th>leverage</th>
      <th>pct_alpha</th>
      <th>pct_</th>
    </tr>
    <tr>
      <th>code</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>000006.XSHE</th>
      <td>-1.146586</td>
      <td>0.332011</td>
      <td>-0.019442</td>
      <td>-1.374479</td>
      <td>1.096001</td>
      <td>0.843916</td>
      <td>-0.449663</td>
      <td>1.682004</td>
      <td>0.024027</td>
      <td>-0.168324</td>
      <td>-0.004083</td>
      <td>-0.021390</td>
    </tr>
    <tr>
      <th>000008.XSHE</th>
      <td>-0.346938</td>
      <td>-0.379614</td>
      <td>-1.236078</td>
      <td>-0.219714</td>
      <td>0.778172</td>
      <td>0.247614</td>
      <td>0.195501</td>
      <td>-1.054256</td>
      <td>-0.048595</td>
      <td>-1.071619</td>
      <td>-0.035061</td>
      <td>-0.052369</td>
    </tr>
    <tr>
      <th>000009.XSHE</th>
      <td>-0.072403</td>
      <td>1.261585</td>
      <td>0.727212</td>
      <td>-0.407907</td>
      <td>0.497564</td>
      <td>-0.571487</td>
      <td>0.259169</td>
      <td>1.682004</td>
      <td>0.769063</td>
      <td>0.689583</td>
      <td>-0.028070</td>
      <td>-0.045378</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c1">#è®¡ç®—æƒé‡å‘é‡
#æ±‚w
#è®¡ç®—å¸‚å€¼å¹³æ–¹æ ¹å æ¯”
</span><span class="n">pool</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">index</span>
<span class="n">get_size</span> <span class="o">=</span> <span class="n">get_fundamentals</span><span class="p">(</span><span class="n">query</span><span class="p">(</span><span class="n">valuation</span><span class="p">.</span><span class="n">code</span><span class="p">,</span><span class="n">valuation</span><span class="p">.</span><span class="n">market_cap</span><span class="p">).</span><span class="nb">filter</span><span class="p">(</span><span class="n">valuation</span><span class="p">.</span><span class="n">code</span><span class="p">.</span><span class="n">in_</span><span class="p">(</span><span class="n">pool</span><span class="p">)),</span><span class="n">date</span><span class="o">=</span><span class="s">'2019-05-06'</span><span class="p">)</span>
<span class="n">get_size</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">get_size</span><span class="p">[</span><span class="s">'code'</span><span class="p">].</span><span class="n">values</span>
<span class="n">get_size</span><span class="p">[</span><span class="s">'l_size'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">get_size</span><span class="p">[</span><span class="s">'market_cap'</span><span class="p">])</span>
<span class="n">get_size</span><span class="p">[</span><span class="s">'w'</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_size</span><span class="p">[</span><span class="s">'l_size'</span><span class="p">]</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">get_size</span><span class="p">[</span><span class="s">'l_size'</span><span class="p">])</span>
<span class="n">W</span> <span class="o">=</span> <span class="p">(</span><span class="n">get_size</span><span class="p">[</span><span class="s">'w'</span><span class="p">].</span><span class="n">values</span><span class="p">).</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">get_size</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
<span class="n">get_size</span><span class="p">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div>

    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>code</th>
      <th>market_cap</th>
      <th>l_size</th>
      <th>w</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>000006.XSHE</th>
      <td>000006.XSHE</td>
      <td>75.1947</td>
      <td>8.671488</td>
      <td>0.001470</td>
    </tr>
    <tr>
      <th>000008.XSHE</th>
      <td>000008.XSHE</td>
      <td>110.6757</td>
      <td>10.520252</td>
      <td>0.001783</td>
    </tr>
    <tr>
      <th>000009.XSHE</th>
      <td>000009.XSHE</td>
      <td>126.3815</td>
      <td>11.241953</td>
      <td>0.001906</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="c1">#è®¡ç®—è¡Œä¸šå¸‚å€¼æƒé‡å æ¯”
</span><span class="n">hy_df</span> <span class="o">=</span> <span class="n">get_industry_exposure</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span><span class="n">date</span><span class="o">=</span><span class="s">'2019-05-06'</span><span class="p">).</span><span class="n">T</span>
<span class="n">hy_df</span><span class="p">[</span><span class="s">'c'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">hy_df</span><span class="p">)</span>

<span class="n">df_c1</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">hy_df</span><span class="p">,</span><span class="n">get_size</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ind_name</span> <span class="o">=</span> <span class="n">get_industries</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'sw_l1'</span><span class="p">).</span><span class="n">index</span>
<span class="n">all_mkt</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df_c1</span><span class="p">[</span><span class="s">'market_cap'</span><span class="p">].</span><span class="n">values</span><span class="p">)</span>
<span class="n">ind_w</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">ind_name</span><span class="p">:</span>
    <span class="n">df_temp</span> <span class="o">=</span> <span class="n">df_c1</span><span class="p">[</span><span class="n">df_c1</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">r_temp</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df_temp</span><span class="p">[</span><span class="s">'market_cap'</span><span class="p">].</span><span class="n">values</span><span class="p">)</span><span class="o">/</span><span class="n">all_mkt</span>
    <span class="n">ind_w</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_temp</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre></td><td class="rouge-code"><pre><span class="c1">#è®¡ç®—æ¯æœŸå› å­æ”¶ç›Šç‡
#æ³¨æ„è¯¥å¾ªç¯å¦‚è®¡ç®—è‡³2019å¹´1æœˆä»½æŠ¥é”™ï¼Œå¯ä»¥å¦èµ·ä¸€ä¸ªcellï¼Œä¿ç•™åŸæ¥çš„factor_f_dfï¼Œè·³è¿‡æŠ¥é”™æ—¥æœŸï¼Œç»§ç»­è®¡ç®—ä¿å­˜factor_f_df
</span><span class="n">factor_f_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">date_list</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'æ­£åœ¨è®¡ç®—{}...'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
    <span class="c1">#è·å–å› å­æš´éœ²
</span>    <span class="n">factor_df</span> <span class="o">=</span> <span class="n">factor_data_y_dict</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">factor_df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">factor_df</span><span class="p">[</span><span class="s">'pct_'</span><span class="p">].</span><span class="n">values</span>
    <span class="n">pool</span>  <span class="o">=</span> <span class="n">factor_df</span><span class="p">.</span><span class="n">index</span>
    
    <span class="c1">#è®¡ç®—å¸‚å€¼å¹³æ–¹æ ¹å æ¯”
</span>    <span class="n">get_size</span> <span class="o">=</span> <span class="n">get_fundamentals</span><span class="p">(</span><span class="n">query</span><span class="p">(</span><span class="n">valuation</span><span class="p">.</span><span class="n">code</span><span class="p">,</span><span class="n">valuation</span><span class="p">.</span><span class="n">market_cap</span><span class="p">).</span><span class="nb">filter</span><span class="p">(</span><span class="n">valuation</span><span class="p">.</span><span class="n">code</span><span class="p">.</span><span class="n">in_</span><span class="p">(</span><span class="n">pool</span><span class="p">)),</span><span class="n">date</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
    <span class="n">get_size</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">get_size</span><span class="p">[</span><span class="s">'code'</span><span class="p">].</span><span class="n">values</span>
    <span class="n">get_size</span><span class="p">[</span><span class="s">'l_size'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">get_size</span><span class="p">[</span><span class="s">'market_cap'</span><span class="p">])</span>
    <span class="n">get_size</span><span class="p">[</span><span class="s">'w'</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_size</span><span class="p">[</span><span class="s">'l_size'</span><span class="p">]</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">get_size</span><span class="p">[</span><span class="s">'l_size'</span><span class="p">])</span>
    <span class="n">W</span> <span class="o">=</span> <span class="p">(</span><span class="n">get_size</span><span class="p">[</span><span class="s">'w'</span><span class="p">].</span><span class="n">values</span><span class="p">).</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">get_size</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1">#è®¡ç®—è¡Œä¸šå¸‚å€¼æƒé‡å æ¯”
</span>    <span class="n">hy_df</span> <span class="o">=</span> <span class="n">get_industry_exposure</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span><span class="n">date</span><span class="o">=</span><span class="n">d</span><span class="p">).</span><span class="n">T</span>
    <span class="n">hy_df</span><span class="p">[</span><span class="s">'c'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">hy_df</span><span class="p">)</span>

    <span class="n">df_c1</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">hy_df</span><span class="p">,</span><span class="n">get_size</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ind_name</span> <span class="o">=</span> <span class="n">get_industries</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'sw_l1'</span><span class="p">).</span><span class="n">index</span>
    <span class="n">all_mkt</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df_c1</span><span class="p">[</span><span class="s">'market_cap'</span><span class="p">].</span><span class="n">values</span><span class="p">)</span>
    <span class="n">ind_w</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">ind_name</span><span class="p">:</span>
        <span class="n">df_temp</span> <span class="o">=</span> <span class="n">df_c1</span><span class="p">[</span><span class="n">df_c1</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r_temp</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df_temp</span><span class="p">[</span><span class="s">'market_cap'</span><span class="p">].</span><span class="n">values</span><span class="p">)</span><span class="o">/</span><span class="n">all_mkt</span>
        <span class="n">ind_w</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">r_temp</span><span class="p">)</span>
        
    <span class="c1">#è¿›è¡Œå¤§Xæ‹¼æ¥
</span>    <span class="n">X_</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">hy_df</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#æœ€ä¼˜åŒ–æ±‚è§£å› å­æ”¶ç›Šç‡
</span>    <span class="n">X</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">X_</span><span class="p">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">w_m</span> <span class="o">=</span> <span class="n">get_size</span><span class="p">[</span><span class="s">'market_cap'</span><span class="p">].</span><span class="n">values</span>
    <span class="n">w_i</span> <span class="o">=</span> <span class="n">ind_w</span>
    
    <span class="c1">#æœ€ä¼˜åŒ–æ±‚è§£å› å­æ”¶ç›Šç‡
</span>    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="n">sum_l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span><span class="s">'nan'</span><span class="p">:</span>
                <span class="n">sum_l</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">w_m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">f</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sum_l</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">func_cons</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">multiply</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">35</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">w_i</span><span class="p">))</span>

    <span class="c1"># åˆå§‹å€¼ + çº¦æŸæ¡ä»¶ 
</span>    <span class="n">f0</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="mi">4</span>
    <span class="n">bnds</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f0</span><span class="p">)</span>
    <span class="n">cons</span> <span class="o">=</span> <span class="p">({</span><span class="s">'type'</span><span class="p">:</span><span class="s">'eq'</span><span class="p">,</span> <span class="s">'fun'</span><span class="p">:</span> <span class="n">func_cons</span><span class="p">})</span>
    <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s">'disp'</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span> <span class="s">'maxiter'</span><span class="p">:</span><span class="mi">1000</span><span class="p">,</span> <span class="s">'ftol'</span><span class="p">:</span><span class="mf">1e-4</span><span class="p">,</span><span class="s">'eps'</span><span class="p">:</span><span class="mf">1e-4</span><span class="p">}</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">f0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">cons</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">'SLSQP'</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
    
    <span class="n">factor_f_df</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s">'x'</span><span class="p">]</span>
    
<span class="n">factor_f_df</span><span class="p">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">factor_f_df</span><span class="p">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div>

    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>size</th>
      <th>beta</th>
      <th>momentum</th>
      <th>residual_volatility</th>
      <th>non_linear_size</th>
      <th>book_to_price_ratio</th>
      <th>liquidity</th>
      <th>earnings_yield</th>
      <th>growth</th>
      <th>leverage</th>
      <th>801010</th>
      <th>801020</th>
      <th>801030</th>
      <th>801040</th>
      <th>801050</th>
      <th>801060</th>
      <th>801070</th>
      <th>801080</th>
      <th>801090</th>
      <th>801100</th>
      <th>801110</th>
      <th>801120</th>
      <th>801130</th>
      <th>801140</th>
      <th>801150</th>
      <th>801160</th>
      <th>801170</th>
      <th>801180</th>
      <th>801190</th>
      <th>801200</th>
      <th>801210</th>
      <th>801220</th>
      <th>801230</th>
      <th>801710</th>
      <th>801720</th>
      <th>801730</th>
      <th>801740</th>
      <th>801750</th>
      <th>801760</th>
      <th>801770</th>
      <th>801780</th>
      <th>801790</th>
      <th>801880</th>
      <th>801890</th>
      <th>c</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2016-06-01</th>
      <td>-0.009260</td>
      <td>-0.003659</td>
      <td>-0.010244</td>
      <td>-0.002543</td>
      <td>0.007603</td>
      <td>-0.003803</td>
      <td>0.001272</td>
      <td>0.007386</td>
      <td>-0.000634</td>
      <td>0.003671</td>
      <td>0.006946</td>
      <td>-0.031840</td>
      <td>-0.000867</td>
      <td>-0.046915</td>
      <td>0.017656</td>
      <td>0.0001</td>
      <td>0.0001</td>
      <td>0.015920</td>
      <td>0.0001</td>
      <td>0.0001</td>
      <td>0.036226</td>
      <td>0.002356</td>
      <td>-0.029217</td>
      <td>0.004911</td>
      <td>-0.002656</td>
      <td>-0.023600</td>
      <td>-0.034101</td>
      <td>-0.016796</td>
      <td>0.0001</td>
      <td>-0.038875</td>
      <td>-0.074809</td>
      <td>0.0001</td>
      <td>0.034301</td>
      <td>-0.020626</td>
      <td>-0.033341</td>
      <td>0.035495</td>
      <td>0.078933</td>
      <td>0.038410</td>
      <td>-0.036883</td>
      <td>0.021977</td>
      <td>0.0001</td>
      <td>-0.012669</td>
      <td>0.045634</td>
      <td>-0.016748</td>
      <td>0.028677</td>
    </tr>
    <tr>
      <th>2016-07-01</th>
      <td>0.012462</td>
      <td>-0.011238</td>
      <td>-0.002829</td>
      <td>-0.015211</td>
      <td>0.005036</td>
      <td>0.020951</td>
      <td>-0.005924</td>
      <td>0.001691</td>
      <td>-0.000044</td>
      <td>-0.006670</td>
      <td>0.022813</td>
      <td>0.046012</td>
      <td>0.025060</td>
      <td>0.033304</td>
      <td>-0.003686</td>
      <td>0.0001</td>
      <td>0.0001</td>
      <td>-0.038392</td>
      <td>0.0001</td>
      <td>0.0001</td>
      <td>0.033882</td>
      <td>-0.016650</td>
      <td>-0.019151</td>
      <td>0.009379</td>
      <td>0.021874</td>
      <td>-0.011609</td>
      <td>0.022437</td>
      <td>-0.003600</td>
      <td>0.0001</td>
      <td>0.018867</td>
      <td>-0.031103</td>
      <td>0.0001</td>
      <td>-0.015403</td>
      <td>-0.020460</td>
      <td>0.012751</td>
      <td>-0.008192</td>
      <td>0.063419</td>
      <td>-0.018692</td>
      <td>0.008465</td>
      <td>0.051487</td>
      <td>0.0001</td>
      <td>0.077507</td>
      <td>-0.061452</td>
      <td>-0.026513</td>
      <td>0.005690</td>
    </tr>
    <tr>
      <th>2016-08-01</th>
      <td>-0.009771</td>
      <td>0.002791</td>
      <td>-0.003688</td>
      <td>-0.004647</td>
      <td>-0.003606</td>
      <td>-0.005247</td>
      <td>-0.008169</td>
      <td>0.001484</td>
      <td>0.002663</td>
      <td>0.004332</td>
      <td>-0.008689</td>
      <td>-0.014698</td>
      <td>0.017007</td>
      <td>0.004196</td>
      <td>-0.000555</td>
      <td>0.0001</td>
      <td>0.0001</td>
      <td>0.017055</td>
      <td>0.0001</td>
      <td>0.0001</td>
      <td>-0.021354</td>
      <td>-0.031483</td>
      <td>0.011884</td>
      <td>-0.006726</td>
      <td>0.001610</td>
      <td>0.006750</td>
      <td>-0.033067</td>
      <td>0.013654</td>
      <td>0.0001</td>
      <td>-0.027213</td>
      <td>0.034572</td>
      <td>0.0001</td>
      <td>0.013710</td>
      <td>0.016699</td>
      <td>0.031289</td>
      <td>-0.005552</td>
      <td>0.005005</td>
      <td>-0.004459</td>
      <td>-0.026485</td>
      <td>0.044937</td>
      <td>0.0001</td>
      <td>0.001988</td>
      <td>0.027248</td>
      <td>-0.028628</td>
      <td>0.047102</td>
    </tr>
  </tbody>
</table>
</div>

<p><strong>å¸‚å€¼é£æ ¼è§£æ</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c1">#é£æ ¼æ”¶ç›Š
</span><span class="p">(</span><span class="n">factor_f_df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:,:</span><span class="mi">10</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="n">cumprod</span><span class="p">().</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f1ff73c1f98&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="http://kan.027cgb.com/627139/bgpc/20200618/output_17_1.png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c1">#çº¯å‡€å› å­ç´¯è®¡æ”¶ç›Š
</span><span class="p">((</span><span class="n">factor_f_df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:,:</span><span class="mi">10</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="n">cumprod</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:].</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'bar'</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f1ff557a320&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="http://kan.027cgb.com/627139/bgpc/20200618/output_18_1.png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c1">#è¡Œä¸šç´¯è®¡æ”¶ç›Š
</span><span class="p">((</span><span class="n">factor_f_df</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">10</span><span class="p">:]</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="n">cumprod</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:].</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'bar'</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f1ff5682860&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="http://kan.027cgb.com/627139/bgpc/20200618/output_19_1.png" /></p>

<p><strong>ç»„åˆæ”¶ç›Šå½’å› </strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="c1">#ä¸­è¯500é€‰50åªè‚¡ç¥¨ï¼Œè¿›è¡Œæ”¶ç›Šåˆ†æ
#è¿›è¡Œå› å­å€¼è®¡ç®—
</span><span class="n">factor_data_50_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">factor_name</span> <span class="o">=</span> <span class="p">[</span><span class="s">'size'</span><span class="p">,</span><span class="s">'beta'</span><span class="p">,</span><span class="s">'momentum'</span><span class="p">,</span><span class="s">'residual_volatility'</span><span class="p">,</span><span class="s">'non_linear_size'</span><span class="p">,</span><span class="s">'book_to_price_ratio'</span><span class="p">,</span><span class="s">'liquidity'</span><span class="p">,</span><span class="s">'earnings_yield'</span><span class="p">,</span><span class="s">'growth'</span><span class="p">,</span><span class="s">'leverage'</span><span class="p">]</span>
<span class="c1">#å¾ªç¯æ—¶é—´åˆ—è¡¨è·å–åŸå§‹å› å­æ•°æ®ç»„æˆdict
</span><span class="k">for</span> <span class="n">end_date</span> <span class="ow">in</span> <span class="n">date_list</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
    <span class="n">end_date</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">end_date</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'æ­£åœ¨è®¡ç®— {} å› å­æ•°æ®......'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">end_date</span><span class="p">))</span>
    <span class="n">stocks_list</span> <span class="o">=</span> <span class="n">get_index_stocks</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">date</span><span class="o">=</span><span class="n">end_date</span><span class="p">)</span>
    <span class="n">pool_</span> <span class="o">=</span> <span class="p">[</span><span class="n">stocks_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stocks_list</span><span class="p">))</span> <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">10</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">stocks_list</span> <span class="o">=</span> <span class="n">pool_</span>
    <span class="c1">#è®¡ç®—è¡Œä¸šå¸‚å€¼æƒé‡å æ¯”
</span>    <span class="n">hy_df</span> <span class="o">=</span> <span class="n">get_industry_exposure</span><span class="p">(</span><span class="n">pool_</span><span class="p">,</span><span class="n">date</span><span class="o">=</span><span class="n">end_date</span><span class="p">).</span><span class="n">T</span>
    <span class="n">hy_df</span><span class="p">[</span><span class="s">'c'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">hy_df</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">factor_data_y_dict</span><span class="p">[</span><span class="n">end_date</span><span class="p">].</span><span class="n">loc</span><span class="p">[</span><span class="n">pool_</span><span class="p">,</span><span class="n">factor_name</span><span class="p">]</span>
    <span class="n">df_pct</span> <span class="o">=</span> <span class="n">factor_data_y_dict</span><span class="p">[</span><span class="n">end_date</span><span class="p">].</span><span class="n">loc</span><span class="p">[</span><span class="n">pool_</span><span class="p">,[</span><span class="s">'pct_'</span><span class="p">]]</span>
    <span class="c1">#è¿›è¡Œå¤§Xæ‹¼æ¥
</span>    <span class="n">X_</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">hy_df</span><span class="p">,</span><span class="n">df_pct</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">factor_data_50_dict</span><span class="p">[</span><span class="n">end_date</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_</span>
<span class="n">factor_data_50_dict</span><span class="p">[</span><span class="n">end_date</span><span class="p">].</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre>æ­£åœ¨è®¡ç®— 2016-06-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2016-07-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2016-08-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2016-09-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2016-10-10 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2016-11-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2016-12-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-01-03 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-02-03 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-03-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-04-05 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-05-02 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-06-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-07-03 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-08-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-09-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-10-09 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-11-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2017-12-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-01-02 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-02-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-03-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-04-02 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-05-02 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-06-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-07-02 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-08-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-09-03 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-10-08 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-11-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2018-12-03 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2019-01-02 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2019-02-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2019-03-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2019-04-01 å› å­æ•°æ®......
æ­£åœ¨è®¡ç®— 2019-05-06 å› å­æ•°æ®......
</pre></td></tr></tbody></table></code></pre></div></div>

<div>

    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>size</th>
      <th>beta</th>
      <th>momentum</th>
      <th>residual_volatility</th>
      <th>non_linear_size</th>
      <th>book_to_price_ratio</th>
      <th>liquidity</th>
      <th>earnings_yield</th>
      <th>growth</th>
      <th>leverage</th>
      <th>801010</th>
      <th>801020</th>
      <th>801030</th>
      <th>801040</th>
      <th>801050</th>
      <th>801060</th>
      <th>801070</th>
      <th>801080</th>
      <th>801090</th>
      <th>801100</th>
      <th>801110</th>
      <th>801120</th>
      <th>801130</th>
      <th>801140</th>
      <th>801150</th>
      <th>801160</th>
      <th>801170</th>
      <th>801180</th>
      <th>801190</th>
      <th>801200</th>
      <th>801210</th>
      <th>801220</th>
      <th>801230</th>
      <th>801710</th>
      <th>801720</th>
      <th>801730</th>
      <th>801740</th>
      <th>801750</th>
      <th>801760</th>
      <th>801770</th>
      <th>801780</th>
      <th>801790</th>
      <th>801880</th>
      <th>801890</th>
      <th>c</th>
      <th>pct_</th>
    </tr>
    <tr>
      <th>code</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>000006.XSHE</th>
      <td>-1.146586</td>
      <td>0.332011</td>
      <td>-0.019442</td>
      <td>-1.374479</td>
      <td>1.096001</td>
      <td>0.843916</td>
      <td>-0.449663</td>
      <td>1.682004</td>
      <td>0.024027</td>
      <td>-0.168324</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>-0.021390</td>
    </tr>
    <tr>
      <th>000049.XSHE</th>
      <td>-1.707221</td>
      <td>0.069808</td>
      <td>-0.015941</td>
      <td>-1.067066</td>
      <td>0.804742</td>
      <td>-0.913589</td>
      <td>-0.468359</td>
      <td>-0.224293</td>
      <td>1.475875</td>
      <td>0.208182</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>-0.072490</td>
    </tr>
    <tr>
      <th>000400.XSHE</th>
      <td>-0.780721</td>
      <td>0.059136</td>
      <td>-0.482627</td>
      <td>-0.455671</td>
      <td>1.049237</td>
      <td>0.938191</td>
      <td>-0.164918</td>
      <td>-0.106578</td>
      <td>0.087378</td>
      <td>-0.786844</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>-0.008929</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="n">factor_f_df</span> <span class="o">=</span> <span class="n">factor_f_df</span><span class="p">.</span><span class="n">T</span>
<span class="n">mark</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">date_list</span><span class="p">[:</span><span class="mi">20</span><span class="p">]:</span>
    <span class="n">end_date</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
    <span class="n">d1</span> <span class="o">=</span> <span class="n">factor_data_50_dict</span><span class="p">[</span><span class="n">end_date</span><span class="p">]</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="n">factor_f_df</span><span class="p">[</span><span class="n">end_date</span><span class="p">]</span>
    <span class="n">y_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">()</span>    
    <span class="n">y_df</span><span class="p">[</span><span class="s">'pct_'</span><span class="p">]</span> <span class="o">=</span> <span class="n">d1</span><span class="p">[</span><span class="s">'pct_'</span><span class="p">]</span>
    <span class="n">y_df</span><span class="p">[</span><span class="s">'p_pct_'</span><span class="p">]</span><span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="n">d1</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">d2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mark</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">y_df_</span> <span class="o">=</span> <span class="n">y_df</span>
        <span class="n">mark</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y_df_</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">y_df_</span><span class="p">,</span><span class="n">y_df</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">y_df_</span><span class="p">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div>

    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pct_</th>
      <th>p_pct_</th>
    </tr>
    <tr>
      <th>code</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>000006.XSHE</th>
      <td>0.000000</td>
      <td>0.038088</td>
    </tr>
    <tr>
      <th>000078.XSHE</th>
      <td>-0.042328</td>
      <td>0.008007</td>
    </tr>
    <tr>
      <th>000511.XSHE</th>
      <td>NaN</td>
      <td>0.053393</td>
    </tr>
  </tbody>
</table>
</div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">y_df_</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">'pct_'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'p_pct_'</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s">'scatter'</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fce3a0ce438&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="http://kan.027cgb.com/627139/bgpc/20200618/output_23_1.png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="c1">#ä»¥20190506ä¸ºä¾‹,æ£€æŸ¥å› å­æš´éœ²åº¦ç™¾åˆ†ä½
</span><span class="n">end_date</span> <span class="o">=</span> <span class="s">'2019-05-06'</span>
<span class="n">d3</span> <span class="o">=</span> <span class="n">factor_data_y_dict</span><span class="p">[</span><span class="n">end_date</span><span class="p">]</span>
<span class="n">d1</span> <span class="o">=</span> <span class="n">factor_data_50_dict</span><span class="p">[</span><span class="n">end_date</span><span class="p">].</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">d_mean</span> <span class="o">=</span> <span class="n">d1</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
<span class="n">d4</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">d3</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:,:</span><span class="mi">10</span><span class="p">].</span><span class="n">T</span><span class="p">,</span><span class="n">d_mean</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">d4</span><span class="p">[</span><span class="s">'mid'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">d4</span><span class="p">)</span>
<span class="p">(</span><span class="n">d4</span><span class="p">.</span><span class="n">rank</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">500</span><span class="p">).</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'bar'</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">d4</span><span class="p">[</span><span class="s">'mid'</span><span class="p">].</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="http://kan.027cgb.com/627139/bgpc/20200618/output_24_0.png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">y_df</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fce3a0d13c8&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="http://kan.027cgb.com/627139/bgpc/20200618/output_25_1.png" /></p>
:ET